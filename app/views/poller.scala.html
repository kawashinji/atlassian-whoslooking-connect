@(viewersWithDetails: String, resourceId: String)

@import play.mvc.Http.Context.Implicit.ctx
@import com.atlassian.connect.play.java.AcHost
@import play.api.Play

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="poller-interval-seconds" content="@Play.current.configuration.getString("whoslooking.poller-interval.seconds")" />
	<meta name="avatar-size" content="@Play.current.configuration.getString("whoslooking.avatar-size")" />
    <meta name="unknown-avatar-url-32" content="@routes.Assets.at("/images/unknown-avatar-32x32.png")" />
	<meta name="unknown-avatar-url-24" content="@routes.Assets.at("/images/unknown-avatar-24x24.png")" />
	<meta name="resourceId" content="@resourceId" />
    <meta content="IE=EDGE" http-equiv="X-UA-Compatible" />
    <link rel="stylesheet" href="@routes.Assets.at("aui/css/aui-all.css")" media="all" />
    <!--[if lt IE 9]><link rel="stylesheet" href="@routes.Assets.at("aui/css/aui-ie.css")" media="all"><![endif]-->
    <!--[if IE 9]><link rel="stylesheet" href="@routes.Assets.at("aui/css/aui-ie9.css")" media="all"><![endif]-->
    <script src="@routes.Assets.at("aui/js/aui-all.js")"></script>
    <!--[if lt IE 9]><script src="@routes.Assets.at("aui/js/aui-ie.js")"></script><![endif]-->
	
    <script src="@routes.Assets.at("third-party/jquery-2.0.1.min.js")"></script>
    <script src="@routes.Assets.at("third-party/purl.js")"></script>    
    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/main.css")" />
    @defining(ctx.args("ac_host").asInstanceOf[AcHost].getBaseUrl()) { baseUrl =>
        <script type="text/javascript" src="@baseUrl/remotable-plugins/all.js"></script>
        <link rel="stylesheet" type="text/css" href="@baseUrl/remotable-plugins/all.css"/>
	}
  </head>
  <script>
  $(function() {
	  	var pollInterval = $('meta[name=poller-interval-seconds]').attr("content") * 1000;
		var avatarSize = $('meta[name=avatar-size]').attr("content");
		var unknownAvatarUrl = $('meta[name=unknown-avatar-url-'+avatarSize+']').attr("content");
	  	var userId = $.url().param('user_id');
  	  	var hostId = $.url().param('oauth_consumer_key');
  	    var resourceId = $('meta[name=resourceId]').attr("content");
  	  	
  	  	var poll = function() {
	  	   $.ajax({
	  	     url: '/viewables/'+ encodeURIComponent(hostId) +'/'+ encodeURIComponent(resourceId) +'/viewers?hostId_for_unicorn='+encodeURIComponent(hostId),	  	     
	  	     type: 'PUT',
	  	   	 contentType: 'application/json',
	  	     data: JSON.stringify({ name: userId }),
	  	     success: function(data) {
	  	         renderViewerList(data);
	  	     }
	  	   });
  	  	}
  	  
	  	var renderedViewers;
  	  	var renderViewerList = function(viewers) {
			
			//hacky deep equals, doesn't matter too much if we get false negatives due to ordering etc...
			if (JSON.stringify(viewers) == JSON.stringify(renderedViewers)) {
				//console.log("Viewers unchanged, not re-rendering.");
				return;
			}
			
			var viewerList = $('<ul>').addClass('whoslooking-onlookers-list').attr('id', 'whoslooking-onlookers-list');
			
			$.each(viewers, function(name, details) {
				if (details) {
					var avatarUrl = details.avatarUrls[avatarSize+"x"+avatarSize];
					var displayName = details.displayName;
				} else {
					var avatarUrl = unknownAvatarUrl;
					var displayName = name;
				}
				
    	        var viewerListItem = $('<li>');
    	        var userFullName = $('<span>').text(displayName).addClass('whoslooking-fullname');
    	    	var avatar = $('<img>').attr('width', avatarSize).attr('height', avatarSize).attr('src', avatarUrl).addClass('whoslooking-avatar');
    	    	viewerListItem.append(avatar).append(userFullName);
    	    	viewerList.append(viewerListItem);
				
			});
	    	$('#whoslooking-onlookers-list').replaceWith(viewerList);
	    	AP.resize();
			renderedViewers = viewers;
  	  	}  	  	
  	  	
  	    if (userId && hostId && resourceId) {	
	  	  	window.onbeforeunload = function() {
	  	    	$.ajax({
		  	    	url: '/viewables/'+ encodeURIComponent(hostId) +'/'+ encodeURIComponent(resourceId) +'/viewers/'+ encodeURIComponent(userId) + '?hostId_for_unicorn='+encodeURIComponent(hostId),
		  	     	type: 'DELETE'
	  	    	});
	  	  	}
			renderViewerList(@Html(viewersWithDetails));  	        
		  	setInterval(poll, pollInterval);
  		}
  });
	
  </script>
  <body>
    <div id="whoslooking-onlookers">
    	<ul  id="whoslooking-onlookers-list"></ul>
    </div>
  </body>
</html>